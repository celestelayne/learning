<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>


<div id="todo">
</div>
<script type="text/template" id="item-template">
  <div>
    <input id="todo_complete" type="checkbox" <%= completed ? 'checked="checked"' : '' %>>
    <%= title %>
  </div>
</script>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="http://documentcloud.github.com/underscore/underscore-min.js"></script>
<script src="http://documentcloud.github.com/backbone/backbone-min.js"></script>
<script>
  var Todo = Backbone.Model.extend({
    initialize: function() {
      console.log('This model has been initialized.');
      this.on('change', function() {
        console.log('attribute changed');
      });

      this.on('change:title', function() {
        console.log('title changed');
      });
    },

    defaults: {
      title: '',
      completed: false
    },

    setTitle: function(newTitle) {
      this.set({ title: newTitle })
    },

    validate: function(attributes) {
      if (attributes.title === undefined) {
        return 'Remember to set a title for your todo.';
      }
    }
  });
  var todo1 = new Todo();

  console.log(JSON.stringify(todo1));
  console.log(todo1.get('title'));
  console.log(todo1.get('completed'));

  var todo2 = new Todo({
    title: 'Check the attributes of both model instances in the console.',
    completed: true
  });
  todo2.setTitle('new title');

  console.log(JSON.stringify(todo2));

  var Person = new Backbone.Model();
  Person.on('change:name', function() { console.log('name changed') });
  Person.set({ name: 'Andrew' }) //logs

  Person.set({ name: 'Jeremy' }, { silent: true }); // doesn't log

  console.log(Person.hasChanged('name')); // true
  console.log(Person.hasChanged(null)); // true, anything changed


  var Person2 = new Backbone.Model({ name: 'Jeremy' });
  Person2.validate = function(attrs) {
    if (!attrs.name) {
      return 'I need your name';
    }
  }
  Person2.set({ name: 'Samuel' });
  console.log(Person2.get('name'));

  Person.unset('name', { validate: true }); // removes attriubtes

  var emptyTodo = new Todo(null, { validate: true });
  console.log(emptyTodo.validationError);


  var TodoView = Backbone.View.extend({
    tagName: 'li',

    todoTemplate: _.template('an example template'),

    events: {
      'dblclick label': 'edit',
      'kepress .edit': 'updateOnEnter',
      'blur .edit': 'close'
    },

    initialize: function(options) {
      this.options = options || {};
    },

    render: function() {
      this.$el.html(this.todoTemplate(this.model.attributes));
      this.input = this.$('.edit');
    },
    
      
    edit: function() {
      // executed when todo label is double clicked
    },

    close: function() {
      // executed when todo loses focus
    },
  
    updateOnEnter: function(e) {
      // executed on each keypress when in todo edit mode,
      // but we'll wait for enter to get in action
    }
  });
  
  var todoView = new TodoView();
  console.log(todoView.el);
  
  var TodosView = Backbone.View.extend({
    tagName: 'ul', // required, but defaults to 'div' if not set
    className: 'container', // optional, you can assign multiple classes to
                            // this property like so: 'container homepage'
    id: 'todos' // optional
  });
  var todosView = new TodosView();
  console.log(todosView.el);
  
  
  // Make some DOM elements
  var button1 = $('<button></button>');
  var button2 = $('<button></button>');
  
  var View = Backbone.View.extend({
    events: {
      click: function(e) {
        console.log(this.el == e.target);
      }
    }
  });
  
  var view = new View({ el: button1 });
  view.setElement(button2);
  
  button1.trigger('click');
  button2.trigger('click'); // returns true
  
  
  var ItemView = Backbone.View.extend({
    events: {},
    
    render: function() {
      this.$el.html(this.template(this.model.attributes));
      return this;
    }
  });
  
  var ListView = Backbone.View.extend({
    template: _.template('...'),
    
    render: function() {
      var items = this.model.get('items');
      _.each(items, function(item) {
        var itemView = new ItemView({ model: item });
        this.$el.append(itemView.render().el);
      }, this);
    }
  });
  
  
  // Collections
  var TodosCollection = Backbone.Collection.extend({
    model: Todo
  });
  

  
  var myTodo = new Todo({ title: 'Read the whole book', id: 2, completed: true });
  
  var todos = new TodosCollection([myTodo]);
  console.log('Collection size: ' + todos.length);
  
  var a = new Todo({ id: 1, title: 'Go to Jamaica', completed: false });
  todos.add(a);
  console.log(todos.get(2) == todos.get(a.cid));

  todos.on('add', function(todo) {
    var done = todo.get('completed') ? 'Yeah!' : 'No';
    console.log("I should" + todo.get('title') + "Have I done it before?" + done);
  });
  
  todos.on('change:title', function(model) {
    console.log('Changed my mind! I should ' + model.get('title'));
  })

  
  todos.remove([myTodo, a]);
  
  a.on({
    'change:title': titleChanged
  });
  
  function titleChanged() {
    console.log('The title was changed');
  }
  
  // Once event binder
  var TodoCounter = { counterA: 0, counterB: 0 };
  _.extend(TodoCounter, Backbone.Events);
  
  var incrA = function() {
    TodoCounter.counterA += 1;
    TodoCounter.trigger('event');
  };
  
  var incrB = function() {
    TodoCounter.counterB += 1;
  };
  
  TodoCounter.once('event', incrA);
  TodoCounter.once('event', incrB);
  
  TodoCounter.trigger('event');
  
  console.log(TodoCounter.counterA === 1);
  console.log(TodoCounter.counterB === 1);
  
  
  var Beatle = Backbone.Model.extend({
    defaults: {
      job: 'musician'
    }
  });
  
  var john = new Beatle({ firstName: 'John', lastName: 'Lennon' });
  var paul = new Beatle({ firstName: 'Paul', lastName: 'McCartney' });
  var george = new Beatle({ firstName: 'George', lastName: 'Harrison' });
  var ringo = new Beatle({ firstName: 'Ringo', lastName: 'Starr' });
 
  var theBeatles = new Backbone.Collection([john, paul, george, ringo]);
  
  var pete = new Beatle({ firstName: 'Pete', lastName: 'Best' });
  
  theBeatles.set([john, paul, george, pete]);
  
  theBeatles.sortBy(function(musician) {
    return musician.get('firstName')
  }).forEach(function(musician) {
    console.log(musician.get('firstName'));
  });
  
  var counter = 1;
  
  console.log(theBeatles.map(function(model) {
    return counter++ + "/ " + model.get('firstName');
  }));
  
  // Also on a collection: min, max, pluck, filter, indexOf, any, size, isEmpty, groupBy, pick, omit, keys, values, pairs (returns list of key value pairs), invert
  
  
  // Collection chain()
  var collection = new Backbone.Collection([
    { name: 'Tim', age: 5 },
    { name: 'Ida', age: 26 },
    { name: 'Rob', age: 55 }
  ]);
  
  var filteredNames = collection.chain() // starts chain
    .filter(function(item) { return item.get('age') > 10; })
    .map(function(item) { return item.get('name'); })
    .value() // ends the chain, returns array
    
  console.log(filteredNames); // ['Ida', 'Rob']
  
  // Backbone specific methods returning this
  collection
        .add({ name: 'Harry', age: 33 })
        .add({ name: 'Pete', age: 34 })
        
  // Backbone is globally available and can be used as an event bus
  Backbone.on('event', function() { console.log('Handled Backbone event'); });
  Backbone.trigger('event')
  
  var ourObject = {};
  _.extend(ourObject, Backbone.Events);
  
  function dancing (msg) { console.log("We started " + msg); }
  
  ourObject.on("dance:tap", dancing);
  ourObject.on("dance:break", dancing);
  ourObject.on('all', function(eventName) {
    console.log('An event was triggered: ' + eventName);
  })  

  ourObject.trigger("dance:tap", "tap dancing. Yeah!");
  ourObject.trigger("dance:break", "break dancing. Yeah!");
  
  ourObject.trigger("dance", "break dancing. Yeah!");
</script>
</body>
</html>